apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Namespace para ambiente PROD no EKS (gerenciado pelo Terraform)
namespace: oficina-mecanica-prod

resources:
  # Base resources (exceto postgres - usa RDS no EKS)
  - ../../base

  # Prod-specific resources
  - secrets.yaml
  - ingress.yaml

# Sobrescrever tags das imagens para usar 'main' em produção
images:
  - name: grecomilani/eureka-server
    newTag: main
  - name: grecomilani/auth-service
    newTag: main
  - name: grecomilani/customer-service
    newTag: main
  - name: grecomilani/catalog-service
    newTag: main
  - name: grecomilani/inventory-service
    newTag: main
  - name: grecomilani/budget-service
    newTag: main
  - name: grecomilani/work-order-service
    newTag: main
  - name: grecomilani/notification-service
    newTag: main

# Exclui o PostgreSQL dos recursos base
patches:
  # Remove postgres StatefulSet
  - target:
      kind: StatefulSet
      name: postgres
    patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgres
      $patch: delete
  # Remove postgres Service
  - target:
      kind: Service
      name: postgres
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres
      $patch: delete
  # Garantir que imagens sempre sejam puxadas (importante em prod para atualizações)
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Always

# Labels comuns para ambiente PROD
commonLabels:
  environment: prod
  managed-by: terraform
  deployed-via: kustomize

# Annotations comuns
commonAnnotations:
  deployment-method: terraform-eks
  cluster: eks-fiap-oficina-mecanica
  criticality: high
