apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Namespace para ambiente PROD no EKS (gerenciado pelo Terraform)
namespace: oficina-mecanica-prod

resources:
  # Base resources (exceto postgres - usa RDS no EKS)
  - ../../base

  # Prod-specific resources
  - ingress.yaml

# Sobrescrever tags das imagens para usar 'main' em produção
images:
  - name: grecomilani/eureka-server
    newTag: main
  - name: grecomilani/auth-service
    newTag: main
  - name: grecomilani/customer-service
    newTag: main
  - name: grecomilani/catalog-service
    newTag: main
  - name: grecomilani/inventory-service
    newTag: main
  - name: grecomilani/budget-service
    newTag: main
  - name: grecomilani/work-order-service
    newTag: main
  - name: grecomilani/notification-service
    newTag: main

# Exclui PostgreSQL e ConfigMap dos recursos base (gerenciados pelo Terraform)
patches:
  # Remove postgres StatefulSet
  - target:
      kind: StatefulSet
      name: postgres
    patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgres
      $patch: delete
  # Remove ConfigMap (gerenciado pelo Terraform no EKS)
  - target:
      kind: ConfigMap
      name: oficina-shared-config
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: oficina-shared-config
      $patch: delete
  # Remove postgres Service
  - target:
      kind: Service
      name: postgres
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres
      $patch: delete
  # Remove ConfigMap (gerenciado por configmap.tf)
  - target:
      kind: ConfigMap
      name: oficina-shared-config
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: oficina-shared-config
      $patch: delete
  # Garantir que imagens sempre sejam puxadas (importante em prod para atualizações)
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Always
  # Eureka Server - aumentar replicas em PROD
  - target:
      kind: Deployment
      name: eureka-server
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 2
  # Eureka NLB - usar internet-facing para PROD
  - target:
      kind: Service
      name: eureka-server-nlb
    patch: |-
      - op: replace
        path: /metadata/annotations/service.beta.kubernetes.io~1aws-load-balancer-scheme
        value: internet-facing
  # Aumentar resources para produção (maior que dev)
  - target:
      kind: Deployment
      name: (auth-service|customer-service|catalog-service|inventory-service|budget-service|work-order-service|notification-service)
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 750m
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/memory
        value: 768Mi
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1500m
  # Aumentar resources do Eureka em produção
  - target:
      kind: Deployment
      name: eureka-server
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources/requests/cpu
        value: 500m
      - op: replace
        path: /spec/template/spec/containers/0/resources/limits/cpu
        value: 1000m
  # Ajustar HPA para produção (min 2, max 5, threshold 80%)
  - target:
      kind: HorizontalPodAutoscaler
      name: (auth-service-hpa|customer-service-hpa|catalog-service-hpa|inventory-service-hpa|budget-service-hpa|work-order-service-hpa|notification-service-hpa)
    patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 2
      - op: replace
        path: /spec/maxReplicas
        value: 5
      - op: replace
        path: /spec/metrics/0/resource/target/averageUtilization
        value: 80
  # Adicionar variável API_GATEWAY_BASE_URL do ConfigMap
  - target:
      kind: Deployment
      name: (auth-service|customer-service|catalog-service|inventory-service|budget-service|work-order-service|notification-service|eureka-server)
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: API_GATEWAY_BASE_URL
          valueFrom:
            configMapKeyRef:
              name: oficina-shared-config
              key: API_GATEWAY_BASE_URL

# Labels comuns para ambiente PROD
commonLabels:
  environment: prod
  managed-by: terraform
  deployed-via: kustomize

# Annotations comuns
commonAnnotations:
  deployment-method: terraform-eks
  cluster: eks-fiap-oficina-mecanica
  criticality: high
