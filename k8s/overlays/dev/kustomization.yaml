apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Namespace para ambiente DEV no EKS (gerenciado pelo Terraform)
namespace: oficina-mecanica-dev

  # Base resources (exceto postgres - usa RDS no EKS)
resources:
- ../../base
- ingress.yaml

# Patches estrat√©gicos para sobrescrever resources e HPA
patchesStrategicMerge:
- patches/resources.yaml
- patches/hpa.yaml

# Exclui PostgreSQL e ConfigMap dos recursos base (gerenciados pelo Terraform)
  # Remove postgres StatefulSet
  # Remove postgres Service
  # Remove ConfigMap (gerenciado pelo Terraform no EKS)
  # Garantir que imagens sempre sejam puxadas (evita cache em dev)
  # Eureka NLB - usar internal para DEV
  # Aumentar startup probe timeout para microservices (exceto eureka)
patches:
- patch: |-
    apiVersion: apps/v1
    kind: StatefulSet
    metadata:
      name: postgres
    $patch: delete
  target:
    kind: StatefulSet
    name: postgres
- patch: |-
    apiVersion: v1
    kind: Service
    metadata:
      name: postgres
    $patch: delete
  target:
    kind: Service
    name: postgres
- patch: |-
    apiVersion: v1
    kind: ConfigMap
    metadata:
      name: oficina-shared-config
    $patch: delete
  target:
    kind: ConfigMap
    name: oficina-shared-config
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/imagePullPolicy
      value: Always
  target:
    kind: Deployment
- patch: |-
    - op: replace
      path: /metadata/annotations/service.beta.kubernetes.io~1aws-load-balancer-scheme
      value: internal
  target:
    kind: Service
    name: eureka-server-nlb
- patch: |-
    - op: replace
      path: /spec/template/spec/containers/0/startupProbe/initialDelaySeconds
      value: 60
    - op: replace
      path: /spec/template/spec/containers/0/startupProbe/failureThreshold
      value: 20
  target:
    kind: Deployment
    name: (auth-service|customer-service|catalog-service|inventory-service|budget-service|work-order-service|notification-service)

# Labels comuns para ambiente DEV
commonLabels:
  deployed-via: kustomize
  environment: dev
  managed-by: terraform

# Annotations comuns
commonAnnotations:
  cluster: eks-fiap-oficina-mecanica
  deployment-method: terraform-eks
images:
- name: grecomilani/auth-service
  newName: grecomilani/auth-service
  newTag: develop
- name: grecomilani/budget-service
  newName: grecomilani/budget-service
  newTag: develop
- name: grecomilani/catalog-service
  newName: grecomilani/catalog-service
  newTag: develop
- name: grecomilani/customer-service
  newName: grecomilani/customer-service
  newTag: develop
- name: grecomilani/eureka-server
  newName: grecomilani/eureka-server
  newTag: develop
- name: grecomilani/inventory-service
  newName: grecomilani/inventory-service
  newTag: develop
- name: grecomilani/notification-service
  newName: grecomilani/notification-service
  newTag: develop
- name: grecomilani/work-order-service
  newName: grecomilani/work-order-service
  newTag: develop
