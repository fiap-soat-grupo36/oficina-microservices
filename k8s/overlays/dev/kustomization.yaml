apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Namespace para ambiente DEV no EKS (gerenciado pelo Terraform)
namespace: oficina-mecanica-dev

resources:
  # Base resources (exceto postgres - usa RDS no EKS)
  - ../../base
  - ingress.yaml

# Exclui PostgreSQL e ConfigMap dos recursos base (gerenciados pelo Terraform)
patches:
  # Remove postgres StatefulSet
  - target:
      kind: StatefulSet
      name: postgres
    patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgres
      $patch: delete
  # Remove postgres Service
  - target:
      kind: Service
      name: postgres
    patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres
      $patch: delete
  # Remove ConfigMap (gerenciado pelo Terraform no EKS)
  - target:
      kind: ConfigMap
      name: oficina-shared-config
    patch: |-
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: oficina-shared-config
      $patch: delete
  # Garantir que imagens sempre sejam puxadas (evita cache em dev)
  - target:
      kind: Deployment
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/imagePullPolicy
        value: Always
  # Eureka NLB - usar internal para DEV
  - target:
      kind: Service
      name: eureka-server-nlb
    patch: |-
      - op: replace
        path: /metadata/annotations/service.beta.kubernetes.io~1aws-load-balancer-scheme
        value: internal
  # Aumentar startup probe timeout para microservices (exceto eureka)
  - target:
      kind: Deployment
      name: "(auth-service|customer-service|catalog-service|inventory-service|budget-service|work-order-service|notification-service)"
    patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/startupProbe/initialDelaySeconds
        value: 60
      - op: replace
        path: /spec/template/spec/containers/0/startupProbe/failureThreshold
        value: 20

# Labels comuns para ambiente DEV
commonLabels:
  environment: dev
  managed-by: terraform
  deployed-via: kustomize

# Annotations comuns
commonAnnotations:
  deployment-method: terraform-eks
  cluster: eks-fiap-oficina-mecanica
