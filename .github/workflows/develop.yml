name: Develop - Deploy to Dev Environment

on:
  push:
    branches:
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  # STEP 1: Detect what changed
  detect-changes:
    name: Detect changes
    uses: ./.github/workflows/_reusable-changes.yml

  # STEP 2: Build once, cache everything
  build-and-cache:
    name: Build and cache
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.modules_json != '[]' &&
      needs.detect-changes.outputs.modules_json != 'null'
    uses: ./.github/workflows/_reusable-build-cache.yml
    with:
      modules_json: ${{ needs.detect-changes.outputs.modules_json }}
      java_version: '21'
      maven_args: ''

  # STEP 3: Test modules
  test:
    name: Test modules
    needs: [detect-changes, build-and-cache]
    if: |
      needs.detect-changes.outputs.modules_json != '[]' &&
      needs.detect-changes.outputs.modules_json != 'null'
    uses: ./.github/workflows/_reusable-test.yml
    with:
      modules_json: ${{ needs.detect-changes.outputs.modules_json }}
      java_version: '21'
      maven_args: ''

  # STEP 4: Build and push Docker images (only changed services)
  docker-build-and-push:
    name: Docker build and push
    needs: [detect-changes, test]
    if: |
      always() &&
      !cancelled() &&
      needs.test.result == 'success' &&
      needs.detect-changes.outputs.modules_json != '[]'
    runs-on: ubuntu-latest
    steps:
      - name: Prepare services JSON for Docker
        id: prepare-services
        run: |
          MODULES_JSON='${{ needs.detect-changes.outputs.modules_json }}'

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ³ Preparing Docker builds for develop environment"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Modules to build: $MODULES_JSON"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # Convert modules JSON to services JSON format for Docker workflow
          SERVICES_JSON=$(echo "$MODULES_JSON" | python3 << 'PYTHON'
          import json
          import sys

          modules = json.load(sys.stdin)
          services = []

          for module in modules:
              # Skip shared-library (not a deployable service)
              if module == "shared-library":
                  continue

              services.append({
                  "service": module,
                  "dockerfile": f"./{module}/Dockerfile"
              })

          print(json.dumps(services))
          PYTHON
          )

          echo "services_json=${SERVICES_JSON}" >> $GITHUB_OUTPUT
          echo "Services JSON: $SERVICES_JSON"

      - name: Build and push Docker images
        if: steps.prepare-services.outputs.services_json != '[]'
        uses: ./.github/workflows/_reusable-dockerhub.yml
        with:
          services_json: ${{ steps.prepare-services.outputs.services_json }}
          branch_tag: develop
          ref_name_for_sha: develop
          sha_short: ${{ github.sha }}
          push_images: true
          max_parallel: 8
        secrets: inherit

  # STEP 5: Terraform apply (if infra changed OR after successful deployment)
  terraform-apply:
    name: Terraform apply (dev)
    needs: [detect-changes, docker-build-and-push]
    if: |
      always() &&
      !cancelled() &&
      (needs.detect-changes.outputs.terraform_changed == 'true' ||
       needs.docker-build-and-push.result == 'success')
    uses: ./.github/workflows/_reusable-terraform.yml
    with:
      working_directory: "infra"
      workspace: "dev"
      environment: "dev"
      auto_apply: true
      tfvars_file: "environments/dev.tfvars"
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
      DATADOG_APP_KEY: ${{ secrets.DATADOG_APP_KEY }}

  # STEP 6: Create PR from develop to main
  create-pr-to-main:
    name: Create PR to main
    needs: [terraform-apply]
    if: success()
    uses: ./.github/workflows/_reusable-create-pr.yml
    with:
      base: main

  # SUMMARY: Deployment status
  deployment-summary:
    name: Deployment summary
    needs: [detect-changes, build-and-cache, test, docker-build-and-push, terraform-apply, create-pr-to-main]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate deployment summary
        run: |
          cat << 'EOF' >> $GITHUB_STEP_SUMMARY
          # ğŸš€ Dev Deployment Summary

          ## Deployment Status

          | Step | Status |
          |------|--------|
          | Detect Changes | ${{ needs.detect-changes.result == 'success' && 'âœ…' || 'âŒ' }} |
          | Build & Cache | ${{ needs.build-and-cache.result == 'success' && 'âœ…' || needs.build-and-cache.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }} |
          | Test | ${{ needs.test.result == 'success' && 'âœ…' || needs.test.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }} |
          | Docker Build & Push | ${{ needs.docker-build-and-push.result == 'success' && 'âœ…' || needs.docker-build-and-push.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }} |
          | Terraform Apply (Dev) | ${{ needs.terraform-apply.result == 'success' && 'âœ…' || needs.terraform-apply.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }} |
          | Create PR to Main | ${{ needs.create-pr-to-main.result == 'success' && 'âœ…' || needs.create-pr-to-main.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ' }} |

          ## Changes Deployed

          - **Environment:** Dev
          - **Modules:** ${{ needs.detect-changes.outputs.modules_json }}
          - **Docker tag:** \`develop\`
          - **Terraform:** ${{ needs.detect-changes.outputs.terraform_changed == 'true' && 'âœ… Applied' || 'â­ï¸ Skipped (no changes)' }}

          ## Next Steps

          ${{ needs.create-pr-to-main.result == 'success' && 'âœ… PR to main has been created. Review and merge to deploy to production.' || 'â„¹ï¸ No PR created (check previous steps for failures)' }}

          ## Optimization Notes

          - Built only changed modules: ${{ needs.detect-changes.outputs.modules_json }}
          - Pushed only changed Docker images (skipped unchanged services)
          - Shared build cache between test jobs
          - Terraform applied only if infra changed or new images deployed

          EOF
