name: Develop - Deploy to Dev Environment

on:
  push:
    branches:
      - develop
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  # Build and test
  build-and-test:
    name: Build and test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Build all modules
        run: mvn clean install -DskipTests

      - name: Run tests
        run: mvn test -Dspring.profiles.active=test

  # Docker build and push
  docker-build-and-push:
    name: Docker build and push
    needs: [detect-changes, test]
    if: |
      always() &&
      !cancelled() &&
      needs.test.result == 'success' &&
      needs.detect-changes.outputs.modules_json != '[]'
    uses: ./.github/workflows/_reusable-dockerhub.yml
    with:
      modules_json: ${{ needs.detect-changes.outputs.modules_json }}
      branch_tag: develop
      ref_name_for_sha: develop
      sha_short: ${{ github.sha }}
      push_images: true
      max_parallel: 8
    secrets: inherit

  # Terraform apply
  terraform-apply:
    name: Terraform apply (dev)
    needs: docker-build-and-push
    uses: ./.github/workflows/_reusable-terraform.yml
    with:
      working_directory: "infra"
      workspace: "dev"
      environment: "dev"
      auto_apply: true
      tfvars_file: "environments/dev.tfvars"
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DATADOG_API_KEY: ${{ secrets.DATADOG_API_KEY }}
      DATADOG_APP_KEY: ${{ secrets.DATADOG_APP_KEY }}

  # Create PR to main
  create-pr-to-main:
    name: Create PR to main
    needs: terraform-apply
    uses: ./.github/workflows/_reusable-create-pr.yml
    with:
      base: main
