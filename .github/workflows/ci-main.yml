name: CI - Oficina Microservices

on:
  push:
    branches: [ develop, feature/**, hotfix/**, main ]
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write

jobs:
  build_and_checks:
    uses: ./.github/workflows/_reusable-build.yml
    with:
      java_version: '21'
      coverage_min_pr: '0.50'
      coverage_min_main: '0.70'
      maven_args: ''
      skip_coverage_checks: true
    secrets: inherit

  sonarcloud:
    needs: build_and_checks
    uses: ./.github/workflows/_reusable-sonar.yml
    with:
      java_version: '21'
      sonar_org: 'fiap-soat-grupo36'
      sonar_project_key: 'fiap-soat-grupo36_oficina-microservices'
      sonar_host: 'https://sonarcloud.io'
      scanner_version: '4.0.0.4121'
      maven_args: ''
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  create_pr:
    name: "Create PR to develop for feature branches"
    runs-on: ubuntu-latest
    needs: build_and_checks
    # Only run on push events for branches matching feature/*
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create Pull Request to develop
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Check if an open PR from this branch to develop already exists
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${branch}`,
              base: 'develop'
            });

            if (prs.length > 0) {
              console.log(`PR already exists: ${prs[0].html_url}`);
              return;
            }

            const title = `Merge ${branch} into develop`;
            const body = `Automated PR created after successful CI on branch ${branch}.`;

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              head: branch,
              base: 'develop',
              title,
              body,
              draft: false
            });

            console.log(`Created PR ${pr.data.html_url}`);

  create_pr_develop_main:
    name: "Create PR from develop to main"
    if: ${{ false }}
    runs-on: ubuntu-latest
    needs: sonarcloud
    steps:
      - run: echo "Desabilitado: PR automatico develop -> main"

  docker_eureka:
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
    needs: [build_and_checks]
    uses: ./.github/workflows/_reusable-dockerhub.yml
    with:
      services_json: |
        [
          { "service": "eureka-server", "dockerfile": "./eureka-server/Dockerfile" }
        ]
      branch_tag: ${{ github.ref_name == 'main' && 'latest' || github.ref_name == 'develop' && 'develop' }}
      ref_name_for_sha: ${{ github.ref_name }}
      sha_short: ${{ github.sha }}
      push_images: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
      max_parallel: 1
    secrets: inherit

  docker_rest:
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
    needs: [docker_eureka]
    uses: ./.github/workflows/_reusable-dockerhub.yml
    with:
      services_json: |
        [
          {
            "service": "auth-service",
            "dockerfile": "./auth-service/Dockerfile"
          },
          {
            "service": "customer-service",
            "dockerfile": "./customer-service/Dockerfile"
          },
          {
            "service": "catalog-service",
            "dockerfile": "./catalog-service/Dockerfile"
          },
          {
            "service": "inventory-service",
            "dockerfile": "./inventory-service/Dockerfile"
          },
          {
            "service": "budget-service",
            "dockerfile": "./budget-service/Dockerfile"
          },
          {
            "service": "work-order-service",
            "dockerfile": "./work-order-service/Dockerfile"
          },
          {
            "service": "notification-service",
            "dockerfile": "./notification-service/Dockerfile"
          }
        ]
      branch_tag: ${{ github.ref_name == 'main' && 'latest' || github.ref_name == 'develop' && 'develop' }}
      ref_name_for_sha: ${{ github.ref_name }}
      sha_short: ${{ github.sha }}
      push_images: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
      max_parallel: 4
    secrets: inherit
