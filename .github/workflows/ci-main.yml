name: CI - Oficina Microservices

on:
  push:
    branches: [develop, feature/**, hotfix/**]
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  build_and_checks:
    uses: ./.github/workflows/_reusable-build.yml
    with:
      java_version: '21'
      coverage_min_pr: '0.50'
      coverage_min_main: '0.70'
      maven_args: ''
    secrets: inherit

  sonarcloud:
    needs: build_and_checks
    uses: ./.github/workflows/_reusable-sonar.yml
    with:
      java_version: '21'
      sonar_org: 'fiap-soat-grupo36'
      sonar_project_key: 'fiap-soat-grupo36_oficina-microservices'
      sonar_host: 'https://sonarcloud.io'
      scanner_version: '4.0.0.4121'
      maven_args: ''
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  docker_eureka:
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
    needs: [build_and_checks]
    uses: ./.github/workflows/_reusable-dockerhub.yml
    with:
      services_json: |
        [
          { "service": "eureka-server", "dockerfile": "./eureka-server/Dockerfile" }
        ]
      branch_tag: ${{ github.ref_name == 'main' && 'latest' || github.ref_name == 'develop' && 'develop' }}
      ref_name_for_sha: ${{ github.ref_name }}
      sha_short: ${{ github.sha }}
      push_images: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
      max_parallel: 1
    secrets: inherit

  docker_rest:
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
    needs: [docker_eureka]
    uses: ./.github/workflows/_reusable-dockerhub.yml
    with:
      services_json: |
        [
          {
            "service": "eureka-server",
            "dockerfile": "./eureka-server/Dockerfile"
          },
          {
            "service": "auth-service",
            "dockerfile": "./auth-service/Dockerfile"
          },
          {
            "service": "customer-service",
            "dockerfile": "./customer-service/Dockerfile"
          },
          {
            "service": "catalog-service",
            "dockerfile": "./catalog-service/Dockerfile"
          },
          {
            "service": "inventory-service",
            "dockerfile": "./inventory-service/Dockerfile"
          },
          {
            "service": "budget-service",
            "dockerfile": "./budget-service/Dockerfile"
          },
          {
            "service": "work-order-service",
            "dockerfile": "./work-order-service/Dockerfile"
          },
          {
            "service": "notification-service",
            "dockerfile": "./notification-service/Dockerfile"
          }
        ]
      branch_tag: ${{ github.ref_name == 'main' && 'latest' || github.ref_name == 'develop' && 'develop' }}
      ref_name_for_sha: ${{ github.ref_name }}
      sha_short: ${{ github.sha }}
      push_images: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
      max_parallel: 4
    secrets: inherit

  terraform:
    name: CI - Infra
    uses: ./.github/workflows/_reusable-ci-terraform.yml
    with:
      working_directory: "infra"
      auto_apply: false
      tfvars_file: "environments/${{ github.ref == 'refs/heads/develop' && 'dev' || 'prod' }}.tfvars"
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      DD_API_KEY: ${{ secrets.DD_API_KEY }}

  create_pr_to_develop:
    name: Create PR to Develop
    uses: ./.github/workflows/_reusable-create-pr.yml
    needs: [docker_rest, terraform]
    if: github.event_name == 'push' && (startsWith(github.ref, 'refs/heads/feature/' ) || startsWith(github.ref, 'refs/heads/hotfix/'))
    with:
      base: develop

  create_pr_develop_main:
    uses: ./.github/workflows/_reusable-create-pr.yml
    needs: [docker_rest, terraform]
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'
    with:
      base: "main"