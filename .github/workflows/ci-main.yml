name: CI - Oficina Microservices

on:
  push:
    branches: [ develop, feature/**, hotfix/**, main ]
  pull_request:
    branches: [ main, develop ]
    types: [ opened, synchronize, reopened ]

permissions:
  contents: read
  pull-requests: write
  actions: read

jobs:
  detect_changes:
    name: Detect changed modules
    runs-on: ubuntu-latest
    outputs:
      modules_json: ${{ steps.set-modules.outputs.modules_json }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Filter paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            root:
              - 'pom.xml'
              - '.github/workflows/**'
              - 'docker-compose.yml'
              - 'k8s/**'
            shared-library:
              - 'shared-library/**'
            eureka-server:
              - 'eureka-server/**'
            auth-service:
              - 'auth-service/**'
            customer-service:
              - 'customer-service/**'
            catalog-service:
              - 'catalog-service/**'
            inventory-service:
              - 'inventory-service/**'
            budget-service:
              - 'budget-service/**'
            work-order-service:
              - 'work-order-service/**'
            notification-service:
              - 'notification-service/**'

      - name: Set modules matrix
        id: set-modules
        uses: actions/github-script@v6
        env:
          FILTERS: ${{ toJSON(steps.filter.outputs) }}
        with:
          script: |
            const ref = context.ref;
            const forceAllBranches = new Set(['refs/heads/main', 'refs/heads/develop']);
            const filters = JSON.parse(process.env.FILTERS);
            const allModules = [
              'eureka-server',
              'shared-library',
              'customer-service',
              'catalog-service',
              'inventory-service',
              'budget-service',
              'auth-service',
              'work-order-service',
              'notification-service'
            ];

            const forceAll =
              forceAllBranches.has(ref) ||
              filters.root === 'true' ||
              filters['shared-library'] === 'true';
            let modules = forceAll
              ? allModules
              : allModules.filter((moduleName) => filters[moduleName] === 'true');

            if (modules.length === 0) {
              modules = allModules;
            }

            core.setOutput('modules_json', JSON.stringify(modules));
            console.log(`Modules selected: ${modules.join(', ')}`);

  build_and_checks:
    uses: ./.github/workflows/_reusable-build.yml
    needs: detect_changes
    with:
      java_version: '21'
      coverage_min_pr: '0.50'
      coverage_min_main: '0.70'
      maven_args: ''
      modules_json: ${{ needs.detect_changes.outputs.modules_json }}
      skip_coverage_checks: true
    secrets: inherit

  sonarcloud:
    needs: build_and_checks
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'push' && github.ref == 'refs/heads/main') }}
    uses: ./.github/workflows/_reusable-sonar.yml
    with:
      java_version: '21'
      sonar_org: 'fiap-soat-grupo36'
      sonar_project_key: 'fiap-soat-grupo36_oficina-microservices'
      sonar_host: 'https://sonarcloud.io'
      scanner_version: '4.0.0.4121'
      maven_args: ''
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  create_pr:
    name: "Create PR to develop for feature branches"
    runs-on: ubuntu-latest
    needs: build_and_checks
    # Only run on push events for branches matching feature/*
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/heads/feature/')
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create Pull Request to develop
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Check if an open PR from this branch to develop already exists
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${branch}`,
              base: 'develop'
            });

            if (prs.length > 0) {
              console.log(`PR already exists: ${prs[0].html_url}`);
              return;
            }

            const title = `Merge ${branch} into develop`;
            const body = `Automated PR created after successful CI on branch ${branch}.`;

            const pr = await github.rest.pulls.create({
              owner,
              repo,
              head: branch,
              base: 'develop',
              title,
              body,
              draft: false
            });

            console.log(`Created PR ${pr.data.html_url}`);

  create_pr_develop_main:
    name: "Create PR from develop to main"
    if: ${{ false }}
    runs-on: ubuntu-latest
    needs: sonarcloud
    steps:
      - run: 'echo "Desabilitado: PR automatico develop -> main"'

  docker_eureka:
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
    needs: [build_and_checks]
    uses: ./.github/workflows/_reusable-dockerhub.yml
    with:
      services_json: |
        [
          { "service": "eureka-server", "dockerfile": "./eureka-server/Dockerfile" }
        ]
      branch_tag: ${{ github.ref_name == 'main' && 'latest' || github.ref_name == 'develop' && 'develop' }}
      ref_name_for_sha: ${{ github.ref_name }}
      sha_short: ${{ github.sha }}
      push_images: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
      max_parallel: 1
    secrets: inherit

  docker_rest:
    if: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
    needs: [docker_eureka]
    uses: ./.github/workflows/_reusable-dockerhub.yml
    with:
      services_json: |
        [
          {
            "service": "auth-service",
            "dockerfile": "./auth-service/Dockerfile"
          },
          {
            "service": "customer-service",
            "dockerfile": "./customer-service/Dockerfile"
          },
          {
            "service": "catalog-service",
            "dockerfile": "./catalog-service/Dockerfile"
          },
          {
            "service": "inventory-service",
            "dockerfile": "./inventory-service/Dockerfile"
          },
          {
            "service": "budget-service",
            "dockerfile": "./budget-service/Dockerfile"
          },
          {
            "service": "work-order-service",
            "dockerfile": "./work-order-service/Dockerfile"
          },
          {
            "service": "notification-service",
            "dockerfile": "./notification-service/Dockerfile"
          }
        ]
      branch_tag: ${{ github.ref_name == 'main' && 'latest' || github.ref_name == 'develop' && 'develop' }}
      ref_name_for_sha: ${{ github.ref_name }}
      sha_short: ${{ github.sha }}
      push_images: ${{ github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') }}
      max_parallel: 4
    secrets: inherit
